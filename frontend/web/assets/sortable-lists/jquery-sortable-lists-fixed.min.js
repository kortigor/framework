/**
 * @desc jQuery plugin to sort html list also the tree structures
 * @author Vladimír Čamaj
 * @license MIT
 */
!function($){$.fn.sortableLists=function(options){var jQBody=$("body").css("position","relative"),defaults={currElClass:"",placeholderClass:"",placeholderCss:{position:"relative",padding:0},hintClass:"",hintCss:{display:"none",position:"relative",padding:0},hintWrapperClass:"",hintWrapperCss:{},baseClass:"",baseCss:{position:"absolute",top:0-parseInt(jQBody.css("margin-top")),left:0-parseInt(jQBody.css("margin-left")),margin:0,padding:0,"z-index":2500},opener:{active:!1,open:"",close:"",openerCss:{float:"left",display:"inline-block","background-position":"center center","background-repeat":"no-repeat"},openerClass:""},maxLevels:!1,listSelector:"ul",listsClass:"",listsCss:{},insertZone:50,insertZonePlus:!1,scroll:20,ignoreClass:"",isAllowed:function(cEl,hint,target){return!0},onDragStart:function(e,cEl){return!0},onChange:function(cEl){return!0},complete:function(cEl){return!0}},setting=$.extend(!0,{},defaults,options),base=$("<"+setting.listSelector+" />").prependTo(jQBody).attr("id","s-l-base").css(setting.baseCss).addClass(setting.listsClass+" "+setting.baseClass),placeholder=$("<li />").attr("id","s-l-placeholder").css(setting.placeholderCss).addClass(setting.placeholderClass),hint=$("<li />").attr("id","s-l-hint").css(setting.hintCss).addClass(setting.hintClass),hintWrapper=$("<"+setting.listSelector+" />").attr("id","s-l-hint-wrapper").addClass(setting.listsClass+" "+setting.hintWrapperClass).css(setting.listsCss).css(setting.hintWrapperCss),opener=$("<span />").addClass("s-l-opener "+setting.opener.openerClass).css(setting.opener.openerCss).on("mousedown",(function(e){var li=$(this).closest("li");return li.hasClass("s-l-closed")?open(li):close(li),!1}));"class"==setting.opener.as?opener.addClass(setting.opener.close):"html"==setting.opener.as?opener.html(setting.opener.close):console.error("jQuerySortableLists opener as background image has been removed with release 2.0.0. Use html instead please.");var state={isDragged:!1,isRelEFP:null,oEl:null,rootEl:{el:$(this),offset:null,rootElClass:$(this).attr("class")},cEl:null,placeholderParentLi:null,upScroll:!1,downScroll:!1,pX:0,pY:0,cX:0,cY:0,isAllowed:!0,e:{pageX:0,pageY:0,clientX:0,clientY:0},doc:$(document),win:$(window)};if(setting.opener.active){if(!setting.opener.open)throw"Opener.open value is not defined. It should be valid url, html or css class.";if(!setting.opener.close)throw"Opener.close value is not defined. It should be valid url, html or css class.";$(this).find("li").each((function(){var li=$(this);li.children(setting.listSelector).length&&(opener.clone(!0).prependTo(li.children("div").first()),li.hasClass("s-l-open")?open(li):close(li))}))}if(!1!==setting.maxLevels){if(isNaN(setting.maxLevels))throw"JQuery-sortable-lists maxLevels values is not a number";$(this).find("li").each((function(){var insideLevs=getInsideLevels($(this)),upperLevs=getUpperLevels($(this));setInsideLevels($(this),insideLevs),setUpperLevels($(this),upperLevs)}))}return this.on("mousedown",(function(e){var target=$(e.target);if(!(!1!==state.isDragged||setting.ignoreClass&&target.hasClass(setting.ignoreClass)||setting.ignoreClass&&target.parents("."+setting.ignoreClass).length)){e.preventDefault();var el=target.closest("li"),rEl=$(this);el[0]&&(setting.onDragStart(e,el),startDrag(e,el,rEl))}}));function startDrag(e,el,rEl){state.isDragged=!0;var elMT=parseInt(el.css("margin-top")),elMB=parseInt(el.css("margin-bottom")),elML=parseInt(el.css("margin-left")),elMR=parseInt(el.css("margin-right")),elXY=el.offset(),elIH=el.innerHeight();state.rootEl={el:rEl,offset:rEl.offset(),rootElClass:rEl.attr("class")},state.cEl={el:el,mT:elMT,mL:elML,mB:elMB,mR:elMR,offset:elXY},state.cEl.xyOffsetDiff={X:e.pageX-state.cEl.offset.left,Y:e.pageY-state.cEl.offset.top},state.cEl.el.addClass("s-l-current "+setting.currElClass),el.before(placeholder);var placeholderNode=state.placeholderNode=$("#s-l-placeholder");el.css({width:el.width(),position:"absolute",top:elXY.top-elMT,left:elXY.left-elML}).prependTo(base),placeholderNode.css({display:"block",height:elIH}),hint.css("height",elIH),state.doc.on("mousemove",dragging).on("mouseup",endDrag)}function dragging(e){if(state.isDragged){var cEl=state.cEl,doc=state.doc,win=state.win;e.pageX||setEventPos(e),doc.scrollTop()>state.rootEl.offset.top-10&&e.clientY<50?state.upScroll?(e.pageY=e.pageY-setting.scroll,$("html, body").each((function(i){$(this).scrollTop($(this).scrollTop()-setting.scroll)})),setCursorPos(e)):setScrollUp(e):doc.scrollTop()+win.height()<state.rootEl.offset.top+state.rootEl.el.outerHeight(!1)+10&&win.height()-e.clientY<50?state.downScroll?(e.pageY=e.pageY+setting.scroll,$("html, body").each((function(i){$(this).scrollTop($(this).scrollTop()+setting.scroll)})),setCursorPos(e)):setScrollDown(e):scrollStop(state),state.oElOld=state.oEl,cEl.el[0].style.visibility="hidden",state.oEl=oEl=elFromPoint(e.pageX,e.pageY),cEl.el[0].style.visibility="visible",showHint(e,state),setCElPos(e,state)}}function endDrag(e){var cEl=state.cEl,hintNode=$("#s-l-hint",state.rootEl.el),hintStyle=hint[0].style,targetEl=null,isHintTarget=!1,hintWrapperNode=$("#s-l-hint-wrapper");"block"==hintStyle.display&&hintNode.length&&state.isAllowed?(targetEl=hintNode,isHintTarget=!0):(targetEl=state.placeholderNode,isHintTarget=!1),offset=targetEl.offset(),cEl.el.animate({left:offset.left-state.cEl.mL,top:offset.top-state.cEl.mT},250,(function(){tidyCurrEl(cEl),targetEl.after(cEl.el[0]),targetEl[0].style.display="none",hintStyle.display="none",hintNode.remove(),hintWrapperNode.removeAttr("id").removeClass(setting.hintWrapperClass),hintWrapperNode.length&&hintWrapperNode.prev("div").append(opener.clone(!0)),isHintTarget?state.placeholderNode.slideUp(150,(function(){state.placeholderParentLi=state.placeholderNode.parent().is(state.rootEl.el)?null:state.placeholderNode.parent().closest("li"),state.placeholderNode.remove(),tidyEmptyLists(),setting.onChange(cEl.el),setting.complete(cEl.el),state.isDragged=!1,!1!==setting.maxLevels&&(recountLevels(cEl.el),state.placeholderParentLi&&recountLevels(state.placeholderParentLi))})):(state.placeholderNode.remove(),tidyEmptyLists(),setting.complete(cEl.el),state.isDragged=!1)})),scrollStop(state),state.doc.unbind("mousemove",dragging).unbind("mouseup",endDrag)}function setScrollUp(e){state.upScroll||(state.upScroll=setInterval((function(){state.doc.trigger("mousemove")}),50))}function setScrollDown(e){state.downScroll||(state.downScroll=setInterval((function(){state.doc.trigger("mousemove")}),50))}function setCursorPos(e){state.pY=e.pageY,state.pX=e.pageX,state.cY=e.clientY,state.cX=e.clientX}function setEventPos(e){e.pageY=state.pY,e.pageX=state.pX,e.clientY=state.cY,e.clientX=state.cX}function scrollStop(state){clearInterval(state.upScroll),clearInterval(state.downScroll),state.upScroll=state.downScroll=!1}function setCElPos(e,state){var cEl=state.cEl;cEl.el.css({top:e.pageY-cEl.xyOffsetDiff.Y-cEl.mT,left:e.pageX-cEl.xyOffsetDiff.X-cEl.mL})}function elFromPoint(x,y){if(!document.elementFromPoint)return null;var isRelEFP=state.isRelEFP,s,res;null===isRelEFP&&((s=state.doc.scrollTop())>0&&(isRelEFP=null==(res=document.elementFromPoint(0,s+$(window).height()-1))||"HTML"==res.tagName.toUpperCase()),(s=state.doc.scrollLeft())>0&&(isRelEFP=null==(res=document.elementFromPoint(s+$(window).width()-1,0))||"HTML"==res.tagName.toUpperCase()));isRelEFP&&(x-=state.doc.scrollLeft(),y-=state.doc.scrollTop());var el=$(document.elementFromPoint(x,y));return state.rootEl.el.find(el).length?el.is("#s-l-placeholder")||el.is("#s-l-hint")?null:el.is("li")?el.is("li")?el:void 0:(el=el.closest("li"))[0]?el:null:null}function showHint(e,state){var oEl=state.oEl;if(oEl&&state.oElOld){var oElH=oEl.outerHeight(!1),relY=e.pageY-oEl.offset().top;setting.insertZonePlus?14>relY?showOnTopPlus(e,oEl,7>relY):oElH-14<relY&&showOnBottomPlus(e,oEl,oElH-7<relY):5>relY?showOnTop(e,oEl):oElH-5<relY&&showOnBottom(e,oEl)}}function showOnTop(e,oEl){if($("#s-l-hint-wrapper",state.rootEl.el).length&&hint.unwrap(),e.pageX-oEl.offset().left<setting.insertZone){if(oEl.prev("#s-l-placeholder").length||!1!==setting.maxLevels&&!checkMaxLevels(!1))return void hint.css("display","none");oEl.before(hint)}else{var children=oEl.children(),list=oEl.children(setting.listSelector).first();if(list.children().first().is("#s-l-placeholder")||!1!==setting.maxLevels&&!checkMaxLevels(!0))return void hint.css("display","none");list.length?list.prepend(hint):(children.first().after(hint),hint.wrap(hintWrapper)),state.oEl&&open(oEl)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnTopPlus(e,oEl,outside){if($("#s-l-hint-wrapper",state.rootEl.el).length&&hint.unwrap(),!outside&&e.pageX-oEl.offset().left>setting.insertZone){var children=oEl.children(),list=oEl.children(setting.listSelector).first();if(list.children().first().is("#s-l-placeholder")||!1!==setting.maxLevels&&!checkMaxLevels(!0))return void hint.css("display","none");list.length?list.prepend(hint):(children.first().after(hint),hint.wrap(hintWrapper)),state.oEl&&open(oEl)}else{if(oEl.prev("#s-l-placeholder").length||!1!==setting.maxLevels&&!checkMaxLevels(!1))return void hint.css("display","none");oEl.before(hint)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnBottom(e,oEl){if($("#s-l-hint-wrapper",state.rootEl.el).length&&hint.unwrap(),e.pageX-oEl.offset().left<setting.insertZone){if(oEl.next("#s-l-placeholder").length||!1!==setting.maxLevels&&!checkMaxLevels(!1))return void hint.css("display","none");oEl.after(hint)}else{var children=oEl.children(),list=oEl.children(setting.listSelector).last();if(list.children().last().is("#s-l-placeholder")||!1!==setting.maxLevels&&!checkMaxLevels(!0))return void hint.css("display","none");list.length?children.last().append(hint):(oEl.append(hint),hint.wrap(hintWrapper)),state.oEl&&open(oEl)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function showOnBottomPlus(e,oEl,outside){if($("#s-l-hint-wrapper",state.rootEl.el).length&&hint.unwrap(),!outside&&e.pageX-oEl.offset().left>setting.insertZone){var children=oEl.children(),list=oEl.children(setting.listSelector).last();if(list.children().last().is("#s-l-placeholder")||!1!==setting.maxLevels&&!checkMaxLevels(!0))return void hint.css("display","none");list.length?children.last().append(hint):(oEl.append(hint),hint.wrap(hintWrapper)),state.oEl&&open(oEl)}else{if(oEl.next("#s-l-placeholder").length||!1!==setting.maxLevels&&!checkMaxLevels(!1))return void hint.css("display","none");oEl.after(hint)}hint.css("display","block"),state.isAllowed=setting.isAllowed(state.cEl.el,hint,hint.parents("li").first())}function open(li){li.removeClass("s-l-closed").addClass("s-l-open"),li.children(setting.listSelector).css("display","block");var opener=li.children("div").children(".s-l-opener").first();"html"==setting.opener.as?opener.html(setting.opener.close):"class"==setting.opener.as&&opener.addClass(setting.opener.close).removeClass(setting.opener.open)}function close(li){li.removeClass("s-l-open").addClass("s-l-closed"),li.children(setting.listSelector).css("display","none");var opener=li.children("div").children(".s-l-opener").first();"html"==setting.opener.as?opener.html(setting.opener.open):"class"==setting.opener.as&&opener.addClass(setting.opener.open).removeClass(setting.opener.close)}function getInsideLevels(li){var levs=0,list=li.children(setting.listSelector);if(list.length){levs++;var maxNestedLevs=0,currLiLevs=0;list.find("li").each((function(i){currLiLevs=getInsideLevels($(this)),maxNestedLevs<currLiLevs&&(maxNestedLevs=currLiLevs)})),maxNestedLevs&&(levs+=maxNestedLevs)}return levs}function setInsideLevels(li,levs){li.data("insideLevels",levs)}function getUpperLevels(li){for(var levs=0,rootEl=state.rootEl.el,parentList=li.closest(setting.listSelector);!parentList.is(rootEl);)levs++,parentList=parentList.parent().closest(setting.listSelector);return levs}function setUpperLevels(li,levs){li.data("upperLevels",levs)}function checkMaxLevels(inside){var insideLevs=state.cEl.el.data("insideLevels"),upperLevs=state.oEl.data("upperLevels");return setting.maxLevels>upperLevs+insideLevs+(inside?1:0)}function recountLevels(li){var rootEl=state.rootEl.el,parentList=li.parent(setting.listSelector);setInsideLevels(li,getInsideLevels(li)),setUpperLevels(li,getUpperLevels(li));var i=0;for(li.find("li").each((function(){var li=$(this);setInsideLevels(li,getInsideLevels(li)),setUpperLevels(li,getUpperLevels(li))}));!parentList.is(rootEl)&&i<50;){var li;setInsideLevels(li=parentList.parent("li"),getInsideLevels(li)),parentList=li.parent(setting.listSelector),i++}}function tidyCurrEl(cEl){var cElStyle=cEl.el[0].style;cEl.el.removeClass(setting.currElClass+" s-l-current"),cElStyle.top="0",cElStyle.left="0",cElStyle.position="relative",cElStyle.width="auto"}function tidyEmptyLists(){$(setting.listSelector,state.rootEl.el).each((function(i){$(this).children().length||($(this).prev("div").children(".s-l-opener").first().remove(),$(this).remove())}))}},$.fn.sortableListsToArray=function(arr,parentId){arr=arr||[];var order=0;return this.children("li").each((function(){var li=$(this),listItem={},id=li.attr("id");if(!id)throw console.log(li),"Previous item in console.log has no id. It is necessary to create the array.";listItem.id=id,listItem.parentId=parentId,listItem.value=li.data("value"),listItem.order=order,arr.push(listItem),li.children("ul,ol").sortableListsToArray(arr,id),order++})),arr},$.fn.sortableListsToHierarchy=function(){var arr=[],order=0;return $(this).children("li").each((function(){var li=$(this),listItem={},id=li.attr("id");if(!id)throw console.log(li),"Previous item in console.log has no id. It is necessary to create the array.";listItem.id=id,listItem.value=li.data("value"),listItem.order=order,arr.push(listItem),listItem.children=li.children("ul,ol").sortableListsToHierarchy(),order++})),arr},$.fn.sortableListsToString=function(expression,arr,parentId){return arr=arr||[],parentId=parentId||"no-parent",$(this).children("li").each((function(){var li=$(this),id=li.attr("id"),matches=id?id.match(expression):null;if(!matches)throw console.log(li),"Previous item in console.log has no id or id is not in required format xx_yy, xx-yy or xx=yy. It is necessary to create valid string.";arr.push(matches[1]+"["+matches[2]+"]="+parentId),$(this).children("ul,ol").sortableListsToString(expression,arr,matches[2])})),arr.join("&")}}(jQuery);